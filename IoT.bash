#!/bin/bash

printf "[*] Running initial scan on local network....\n\n"
sudo nmap -sn 192.168.1.0/24 > InitialScan
grep for InitialScan | cut -d ' ' -f5 > IPs

file="/home/bjakell/SeniorProject/IPs"
while IFS= read -r line
do
    printf '[*] Scanning individual host: %s'"$line"
    nmap -p 23 "$line" > TelnetPorts
    nmap -p 22 "$line" > SSHPorts
    printf "\n"
    TelOpen=$(grep tcp TelnetPorts | cut -d ' ' -f2)
    SSHOpen=$(grep tcp TelnetPorts | cut -d ' ' -f2)
    if [ "$TelOpen" = "open" ]
    then
        printf '\t[*] Found open telnet port on: %s'"$line"
        printf "\n"
        echo "$line" > TelIP.txt
        printf '\t\t[*] Brute forcing default username and password...'
        printf '\n'
        nmap -p 23 --script telnet-brute --script-args userdb=user.txt,passdb=passwd.txt $line > TelCredOutput
        isTelValid=$(tail -n 5 TelCredOutput | head -n 2 | tail -n 2 | head -n 1 | cut -d '-' -f2 | cut -d ' ' -f2)
        if [ "$isTelValid" = "Valid" ]
        then
            cat TelCredOutput  | grep -A1 "Accounts" | grep -v "Accou" | grep -o "[a-zA-Z0-9][^:]*:[^ ]*" | cut -d ':' -f1 > TelUsername.txt
            tail -n 5 TelCredOutput | head -n 1 | cut -d ':' -f2 | cut -d '-' -f1 > TelPassword.txt

            printf '\t\t[*] Valid credentials found. Changing default password...'
            printf '\n'
            python telnetConnect.py
            rm TelUsername.txt
            rm TelPassword.txt
            rm TelIP.txt
        else
            printf '\t\t\t[*] No default username/password combination found.'
            printf '\n'
            rm TelIP.txt
        fi
    fi

    if [ "$SSHOpen" = "open" ]
    then
        printf '\t[*] Found open ssh port on: %s'"$line"
        printf "\n"
        echo "$line" > SSHIP.txt
        printf '\t\t[*] Brute forcing default username and password...'
        printf '\n'
        nmap -p 22 --script telnet-brute --script-args userdb=user.txt,passdb=passwd.txt $line > SSHCredOutput
        isSSHValid=$(tail -n 5 SSHCredOutput | head -n 2 | tail -n 2 | head -n 1 | cut -d '-' -f2 | cut -d ' ' -f2)
        if [ "$isSSHValid" == "Valid" ]
        then
            cat SSHCredOutput  | grep -A1 "Accounts" | grep -v "Accou" | grep -o "[a-zA-Z0-9][^:]*:[^ ]*" | cut -d ':' -f1 > SSHuser.txt
            tail -n 5 SSHCredOutput | head -n 1 | cut -d ':' -f2 | cut -d '-' -f1 > SSHpassword.txt

            printf '\t\t[*] Valid credentials found. Changing default password...'
            printf '\n'
            python sshConnect.py
            rm SSHusername.txt
            rm SSHpassword.txt
            rm SSHIP.txt
        else
            printf '\t\t\t[*] No default username/password combination found.'
            printf '\n'
            rm SSHIP.txt
        fi
    fi
done < "$file"

printf '[*] Scan complete.\n'

rm InitialScan
rm IPs
rm TelnetPorts
rm SSHPorts
rm TelCredOutput
rm SSHCredOutput
